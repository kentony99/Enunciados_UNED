-- SOLUCION PUNTO 2 
SELECT ORDENES.NumeroOrden, ORDENES.Descripcion, ORDENES.FechaIngreso, ORDENES.FechaEntrega, ORDENES_ESTADOS.Descripcion, CLIENTES.Cedula,
CLIENTES.Nombre + ' ' + CLIENTES.Apellido1 + ' ' + CLIENTES.Apellido2 AS NOMBRE_COMPLETO,
CLIENTES.Telefono, VEHICULO.Placa, VEHICULO.Marca, VEHICULO.Modelo
FROM ORDENES
INNER JOIN ORDENES_ESTADOS ON ORDENES.EstadoOrden = ORDENES_ESTADOS.IDEstado
INNER JOIN CLIENTES ON ORDENES.CedulaCliente = CLIENTES.Cedula
INNER JOIN VEHICULO ON ORDENES.PlacaVehiculo = VEHICULO.Placa

-- SOLUCION PUNTO 3
SELECT ORDENES_ESTADOS.Descripcion, COUNT(*) AS Cantidad
FROM ORDENES
INNER JOIN ORDENES_ESTADOS ON ORDENES.EstadoOrden = ORDENES_ESTADOS.IDEstado
GROUP BY ORDENES_ESTADOS.Descripcion
ORDER BY Cantidad DESC

-- SOLUCION PUNTO 4 (Opci n 1)
SELECT ORDENES.CedulaCliente, ORDENES.NumeroOrden, ORDENES.Descripcion,SERVICIOS.CostoManoObra , SUM(REPUESTOS.CostoRepuesto) AS COSTO_REPUESTO,
(SERVICIOS.CostoManoObra + SUM(REPUESTOS.CostoRepuesto)) * 1.13 AS IVA
FROM SERVICIOS_POR_ORDEN
INNER JOIN SERVICIOS ON  SERVICIOS.IDServicio = SERVICIOS_POR_ORDEN.IdServicio 
INNER JOIN ORDENES ON ORDENES.NumeroOrden = SERVICIOS_POR_ORDEN.NumeroOrden 
INNER JOIN ORDENES_ESTADOS ON ORDENES.EstadoOrden = ORDENES_ESTADOS.IDEstado AND ORDENES_ESTADOS.Descripcion = 'Completada'
INNER JOIN REPUESTOS_POR_SERVICIOS ON SERVICIOS_POR_ORDEN.IdServicio = REPUESTOS_POR_SERVICIOS.IdServicio
INNER JOIN REPUESTOS ON REPUESTOS.NumeroParte = REPUESTOS_POR_SERVICIOS.NumeroParte
GROUP BY ORDENES.CedulaCliente, ORDENES.NumeroOrden, ORDENES.Descripcion, SERVICIOS.CostoManoObra

-- SOLUCION PUNTO 4 (Opci n 2)
SELECT ORDENES.CedulaCliente, ORDENES.NumeroOrden, ORDENES.Descripcion,SERVICIOS.CostoManoObra , SUM(COALESCE(REPUESTOS.CostoRepuesto, 0)) AS COSTO_REPUESTO,
(SERVICIOS.CostoManoObra + SUM(COALESCE(REPUESTOS.CostoRepuesto, 0))) * 1.13 AS IVA
FROM SERVICIOS_POR_ORDEN
INNER JOIN SERVICIOS ON  SERVICIOS.IDServicio = SERVICIOS_POR_ORDEN.IdServicio 
INNER JOIN ORDENES ON ORDENES.NumeroOrden = SERVICIOS_POR_ORDEN.NumeroOrden 
INNER JOIN ORDENES_ESTADOS ON ORDENES.EstadoOrden = ORDENES_ESTADOS.IDEstado AND ORDENES_ESTADOS.Descripcion = 'Completada'
LEFT JOIN REPUESTOS_POR_SERVICIOS ON SERVICIOS_POR_ORDEN.IdServicio = REPUESTOS_POR_SERVICIOS.IdServicio
LEFT JOIN REPUESTOS ON REPUESTOS.NumeroParte = REPUESTOS_POR_SERVICIOS.NumeroParte
GROUP BY ORDENES.CedulaCliente, ORDENES.NumeroOrden, ORDENES.Descripcion, SERVICIOS.CostoManoObra


-- SOLUCION PUNTO 5
UPDATE ORDENES
SET FechaEntrega = DATEADD(DD,3,FechaEntrega)
FROM ORDENES,ORDENES_ESTADOS
WHERE ORDENES.EstadoOrden = ORDENES_ESTADOS.IDEstado
AND ORDENES_ESTADOS.Descripcion NOT IN ('Completada','Cancelada')